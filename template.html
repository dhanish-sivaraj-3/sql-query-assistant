<!DOCTYPE html>
<html>
<head>
    <title>Multi-Database SQL Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen p-4">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <i class="fas fa-database text-4xl text-blue-500 mr-3"></i>
                <h1 class="text-4xl font-bold text-gray-800">Multi-Database SQL Assistant</h1>
            </div>
            <p class="text-xl text-gray-600">Query Multiple Databases with Natural Language</p>
            <div class="mt-4 flex justify-center space-x-4">
                <span id="dbStatus" class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">
                    <i class="fas fa-database mr-1"></i>Database: Checking...
                </span>
                <span id="aiStatus" class="px-3 py-1 bg-red-100 text-red-800 rounded-full text-sm">
                    <i class="fas fa-robot mr-1"></i>AI: Checking...
                </span>
                <span id="selectedDb" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm hidden">
                    <i class="fas fa-table mr-1"></i>Database: None
                </span>
            </div>
        </div>

        <!-- Database Selection -->
        <div class="bg-white rounded-2xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-database mr-2"></i>Select Database
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4" id="databaseList">
                <!-- Databases will be loaded here -->
            </div>
            
            <!-- Custom Database Connection -->
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <h3 class="text-lg font-semibold text-gray-700 mb-3">
                    <i class="fas fa-plug mr-2"></i>Connect Custom Database
                </h3>
                
                <!-- Database Type Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Database Type</label>
                    <div class="flex space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="dbType" value="mysql" checked class="db-type-radio">
                            <span class="ml-2">MySQL</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="dbType" value="sqlserver" class="db-type-radio">
                            <span class="ml-2">SQL Server</span>
                        </label>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Server</label>
                        <input type="text" id="customServer" placeholder="e.g., DESKTOP-PL02DVO or 192.168.0.86" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Port</label>
                        <input type="text" id="customPort" placeholder="3306 for MySQL, 1433 for SQL Server" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="customUsername" placeholder="Database username" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="customPassword" placeholder="Database password" 
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Database Name (Optional)</label>
                    <input type="text" id="customDatabase" placeholder="Leave empty to see all databases" 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <button id="connectCustomDb" 
                        class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">
                    <i class="fas fa-link mr-2"></i>Connect to Custom Database
                </button>
            </div>
        </div>

        <!-- Query Form (Initially Hidden) -->
        <div id="queryFormSection" class="bg-white rounded-2xl shadow-lg p-6 mb-8 hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-comment-dots mr-2"></i>Ask Questions About Your Data
            </h2>
            <form id="queryForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        What would you like to know about <span id="currentDbName" class="font-semibold">your database</span>?
                    </label>
                    <textarea 
                        id="query" 
                        name="query"
                        rows="3"
                        placeholder="Example: Show me the top 10 products by sales..."
                        class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
                        required
                    ></textarea>
                </div>
                <div class="flex space-x-4">
                    <button 
                        type="submit"
                        class="flex-1 px-6 py-3 bg-blue-500 text-white rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 font-semibold text-lg transition duration-200"
                    >
                        <i class="fas fa-paper-plane mr-2"></i>Generate & Execute SQL
                    </button>
                    <button 
                        type="button"
                        id="clearHistory"
                        class="px-6 py-3 bg-gray-500 text-white rounded-xl hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-gray-500 font-semibold transition duration-200"
                    >
                        <i class="fas fa-trash mr-2"></i>Clear History
                    </button>
                </div>
            </form>
        </div>

        <!-- Database Info -->
        <div id="databaseInfo" class="bg-blue-50 rounded-2xl p-6 mb-8 hidden">
            <h3 class="text-lg font-semibold text-blue-800 mb-3">
                <i class="fas fa-info-circle mr-2"></i>Database Schema Information
            </h3>
            <div id="tablesList" class="text-blue-700">
                <!-- Tables with columns will be listed here -->
            </div>
        </div>

        <!-- Results Section -->
        <div id="results" class="hidden"></div>

        <!-- Conversation History -->
        <div id="historySection" class="bg-white rounded-2xl shadow-lg p-6 mt-8 hidden">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">
                <i class="fas fa-history mr-2"></i>Conversation History
            </h3>
            <div id="historyList" class="space-y-3"></div>
        </div>

        <!-- Example Queries -->
        <div class="bg-green-50 rounded-2xl p-6 mt-8">
            <h3 class="text-lg font-semibold text-green-800 mb-3">
                <i class="fas fa-lightbulb mr-2"></i>Try These Example Queries:
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                <button class="example-btn bg-white text-green-600 px-4 py-3 rounded-lg border border-green-200 hover:bg-green-50 transition duration-200 text-left">
                    "Show top 10 products by sales"
                </button>
                <button class="example-btn bg-white text-green-600 px-4 py-3 rounded-lg border border-green-200 hover:bg-green-50 transition duration-200 text-left">
                    "What's the monthly revenue trend?"
                </button>
                <button class="example-btn bg-white text-green-600 px-4 py-3 rounded-lg border border-green-200 hover:bg-green-50 transition duration-200 text-left">
                    "How many patients were admitted last month?"
                </button>
                <button class="example-btn bg-white text-green-600 px-4 py-3 rounded-lg border border-green-200 hover:bg-green-50 transition duration-200 text-left">
                    "Show customer distribution by region"
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentDatabase = null;
        let sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
        let currentConnectionInfo = null;
        
        // Check system status on load
        async function checkSystemStatus() {
            try {
                const response = await fetch('/api/health');
                const data = await response.json();
                
                const dbStatus = document.getElementById('dbStatus');
                const aiStatus = document.getElementById('aiStatus');
                
                if (data.database_connected) {
                    dbStatus.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
                    dbStatus.innerHTML = '<i class="fas fa-database mr-1"></i>Database: Connected';
                    
                    // Load available databases
                    loadDatabases();
                }
                if (data.gemini_connected) {
                    aiStatus.className = 'px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm';
                    aiStatus.innerHTML = '<i class="fas fa-robot mr-1"></i>AI: Gemini Ready';
                }
                
            } catch (error) {
                console.error('Status check failed:', error);
            }
        }
        
        // Load available databases
        async function loadDatabases() {
            try {
                const response = await fetch('/api/databases');
                const data = await response.json();
                
                const databaseList = document.getElementById('databaseList');
                
                if (data.success && data.databases.length > 0) {
                    data.databases.forEach(db => {
                        const dbCard = document.createElement('div');
                        dbCard.className = 'bg-blue-50 rounded-lg p-4 border border-blue-200 cursor-pointer hover:bg-blue-100 transition duration-200';
                        dbCard.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-database text-blue-500 mr-3"></i>
                                <div>
                                    <h3 class="font-semibold text-blue-800">${db}</h3>
                                    <p class="text-blue-600 text-sm">Click to select</p>
                                </div>
                            </div>
                        `;
                        dbCard.addEventListener('click', () => selectDatabase(db));
                        databaseList.appendChild(dbCard);
                    });
                } else {
                    databaseList.innerHTML = '<p class="text-gray-500">No databases found. The databases (ecommerce, healthcare) should appear here automatically.</p>';
                }
            } catch (error) {
                console.error('Error loading databases:', error);
            }
        }
        
        // Select database
        async function selectDatabase(database) {
            currentDatabase = database;
            
            // Update UI
            document.getElementById('selectedDb').classList.remove('hidden');
            document.getElementById('selectedDb').innerHTML = `<i class="fas fa-table mr-1"></i>Database: ${database}`;
            document.getElementById('queryFormSection').classList.remove('hidden');
            document.getElementById('currentDbName').textContent = database;
            
            // Load database info
            await loadDatabaseInfo(database);
            
            // Scroll to query form
            document.getElementById('queryFormSection').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Load database information with column details
        async function loadDatabaseInfo(database) {
            try {
                const response = await fetch(`/api/databases/${database}/tables`);
                const data = await response.json();
                
                const databaseInfo = document.getElementById('databaseInfo');
                const tablesList = document.getElementById('tablesList');
                
                if (data.success && Object.keys(data.tables).length > 0) {
                    databaseInfo.classList.remove('hidden');
                    
                    let tablesHTML = `
                        <div class="flex items-center mb-4">
                            <i class="fas fa-info-circle mr-2"></i>
                            <span class="font-semibold">Database Schema: ${database}</span>
                            <span class="ml-2 px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
                                ${data.table_count} table${data.table_count !== 1 ? 's' : ''}
                            </span>
                        </div>
                    `;
                    
                    Object.entries(data.tables).forEach(([tableName, columns]) => {
                        tablesHTML += `
                            <div class="bg-white rounded-lg p-4 border border-blue-200 mb-4 shadow-sm">
                                <div class="flex items-center justify-between mb-3">
                                    <div class="flex items-center">
                                        <i class="fas fa-table text-blue-500 mr-2"></i>
                                        <span class="font-semibold text-blue-800 text-lg">${tableName}</span>
                                    </div>
                                    <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                                        ${columns.length} column${columns.length !== 1 ? 's' : ''}
                                    </span>
                                </div>
                                <div class="border-t border-gray-200 pt-3">
                                    <p class="text-sm font-medium text-gray-700 mb-2">Columns:</p>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        ${columns.map(col => `
                                            <div class="text-sm bg-gray-50 rounded-lg px-3 py-2 border border-gray-200 hover:bg-blue-50 transition-colors">
                                                <div class="flex items-center justify-between">
                                                    <span class="font-medium text-gray-900">${col.name}</span>
                                                    <div class="flex space-x-1">
                                                        ${col.primary_key ? '<span class="px-1 bg-green-100 text-green-800 rounded text-xs font-bold" title="Primary Key">PK</span>' : ''}
                                                        ${!col.nullable ? '<span class="px-1 bg-red-100 text-red-800 rounded text-xs font-bold" title="Not Null">NN</span>' : ''}
                                                    </div>
                                                </div>
                                                <div class="text-xs text-gray-500 mt-1">${col.type}</div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    tablesList.innerHTML = tablesHTML;
                } else {
                    databaseInfo.classList.remove('hidden');
                    tablesList.innerHTML = '<p class="text-blue-700 p-4 bg-blue-50 rounded-lg">No tables found in this database</p>';
                }
            } catch (error) {
                console.error('Error loading database info:', error);
                const databaseInfo = document.getElementById('databaseInfo');
                const tablesList = document.getElementById('tablesList');
                databaseInfo.classList.remove('hidden');
                tablesList.innerHTML = '<p class="text-red-700 p-4 bg-red-50 rounded-lg">Error loading database schema information</p>';
            }
        }
        
        // Handle custom database connection
        document.getElementById('connectCustomDb').addEventListener('click', async function() {
            const server = document.getElementById('customServer').value;
            const database = document.getElementById('customDatabase').value;
            const username = document.getElementById('customUsername').value;
            const password = document.getElementById('customPassword').value;
            const port = document.getElementById('customPort').value;
            const dbType = document.querySelector('input[name="dbType"]:checked').value;
            
            if (!server) {
                alert('Please enter server address');
                return;
            }
            
            if (!username) {
                alert('Please enter username');
                return;
            }
            
            if (!password) {
                alert('Please enter password');
                return;
            }
            
            const connectBtn = document.getElementById('connectCustomDb');
            const originalText = connectBtn.innerHTML;
            
            try {
                // Show loading state
                connectBtn.disabled = true;
                connectBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
                
                const response = await fetch('/api/connect-custom', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        server: server,
                        database: database,
                        db_type: dbType,
                        username: username,
                        password: password,
                        port: port
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Show available databases for selection
                    if (data.available_databases && data.available_databases.length > 0) {
                        showDatabaseSelection(data.available_databases, server, dbType, data);
                        alert('✅ Connection successful! Please select a database from the list below.');
                    } else if (data.database) {
                        selectDatabase(data.database);
                        alert('✅ Connection successful! Database selected.');
                    } else {
                        alert('✅ Connected successfully but no databases found or selected.');
                    }
                    
                    // Clear password for security, keep other fields for convenience
                    document.getElementById('customPassword').value = '';
                    document.getElementById('customDatabase').value = '';
                    
                } else {
                    alert('❌ Failed to connect: ' + data.error);
                }
            } catch (error) {
                alert('❌ Connection error: ' + error.message);
            } finally {
                // Restore button state
                connectBtn.disabled = false;
                connectBtn.innerHTML = originalText;
            }
        });

        function showDatabaseSelection(databases, server, dbType, connectionData) {
            const databaseList = document.getElementById('databaseList');
            
            // Clear existing custom databases to avoid duplicates
            const existingCustomDbs = databaseList.querySelectorAll('.bg-green-50');
            existingCustomDbs.forEach(db => db.remove());
            
            databases.forEach(db => {
                const dbCard = document.createElement('div');
                dbCard.className = 'bg-green-50 rounded-lg p-4 border border-green-200 cursor-pointer hover:bg-green-100 transition duration-200 mb-2';
                dbCard.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-database text-green-500 mr-3"></i>
                        <div>
                            <h3 class="font-semibold text-green-800">${db}</h3>
                            <p class="text-green-600 text-sm">Custom ${dbType.toUpperCase()} • ${server}</p>
                        </div>
                    </div>
                `;
                dbCard.addEventListener('click', () => {
                    selectDatabase(db);
                    // Store connection info for future queries
                    currentConnectionInfo = {
                        server: server,
                        db_type: dbType,
                        username: document.getElementById('customUsername').value,
                        password: document.getElementById('customPassword').value
                    };
                });
                databaseList.appendChild(dbCard);
            });
            
            // Scroll to show the new databases
            databaseList.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        // Handle form submission
        document.getElementById('queryForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (!currentDatabase) {
                alert('Please select a database first');
                return;
            }
            await processQuery(document.getElementById('query').value, currentDatabase);
        });

        // Handle example buttons
        document.querySelectorAll('.example-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if (!currentDatabase) {
                    alert('Please select a database first');
                    return;
                }
                document.getElementById('query').value = this.textContent.trim();
                processQuery(this.textContent.trim(), currentDatabase);
            });
        });

        // Clear history
        document.getElementById('clearHistory').addEventListener('click', function() {
            sessionId = 'session_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('historySection').classList.add('hidden');
            document.getElementById('historyList').innerHTML = '';
        });

        async function processQuery(query, database) {
            const button = document.querySelector('#queryForm button');
            const resultsDiv = document.getElementById('results');
            
            // Show loading state
            button.disabled = true;
            button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Generating SQL with Gemini...';
            resultsDiv.classList.add('hidden');
            
            try {
                const response = await fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        query: query,
                        database: database,
                        session_id: sessionId 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displaySuccessResults(data);
                    addToHistory(query, data, database);
                } else {
                    displayError(data.error);
                }
                
            } catch (error) {
                displayError('Network error: ' + error.message);
            } finally {
                button.disabled = false;
                button.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>Generate & Execute SQL';
            }
        }

        function displaySuccessResults(data) {
            const resultsDiv = document.getElementById('results');
            
            resultsDiv.innerHTML = `
                <div class="bg-white rounded-2xl shadow-lg p-6 space-y-6">
                    <!-- Success Header -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center text-green-600">
                            <i class="fas fa-check-circle text-2xl mr-3"></i>
                            <h2 class="text-2xl font-semibold">Query Successful</h2>
                        </div>
                        <div class="flex space-x-2">
                            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm">
                                DB: ${data.database}
                            </span>
                            <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm">
                                ${data.execution_result.row_count} rows • ${data.execution_time_ms}ms
                            </span>
                        </div>
                    </div>
                    
                    <!-- AI Explanation -->
                    <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                        <h3 class="font-semibold text-blue-800 mb-2">
                            <i class="fas fa-robot mr-2"></i>Gemini Analysis
                        </h3>
                        <p class="text-blue-700">${data.explanation || 'No explanation available'}</p>
                    </div>
                    
                    <!-- SQL Query -->
                    <div class="bg-gray-50 border border-gray-200 rounded-xl p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="font-semibold text-gray-800">
                                <i class="fas fa-code mr-2"></i>Generated SQL
                            </h3>
                            <button onclick="copyToClipboard('${data.generated_sql.replace(/'/g, "\\'")}')" 
                                    class="px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300">
                                <i class="fas fa-copy mr-1"></i>Copy
                            </button>
                        </div>
                        <pre class="bg-gray-800 text-green-400 p-4 rounded-lg overflow-x-auto text-sm mt-2">${data.generated_sql}</pre>
                    </div>
                    
                    <!-- Results Table -->
                    <div class="bg-white border border-gray-200 rounded-xl overflow-hidden">
                        <h3 class="font-semibold text-gray-800 p-4 border-b border-gray-200">
                            <i class="fas fa-table mr-2"></i>Query Results
                            <span class="text-sm font-normal text-gray-600 ml-2">(${data.execution_result.row_count} rows)</span>
                        </h3>
                        <div class="p-4 overflow-x-auto">
                            ${renderResultsTable(data.execution_result.data, data.execution_result.columns)}
                        </div>
                    </div>
                </div>
            `;
            
            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function renderResultsTable(data, columns) {
            if (!data || data.length === 0) {
                return '<p class="text-gray-500">No data returned</p>';
            }
            
            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
            `;
            
            // Table headers
            columns.forEach(col => {
                tableHTML += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">${col}</th>`;
            });
            
            tableHTML += `
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            // Table rows (limit to 50 for display)
            data.slice(0, 50).forEach(row => {
                tableHTML += '<tr>';
                columns.forEach(col => {
                    const value = row[col];
                    tableHTML += `<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${value !== null ? value : 'NULL'}</td>`;
                });
                tableHTML += '</tr>';
            });
            
            tableHTML += `
                    </tbody>
                </table>
            `;
            
            if (data.length > 50) {
                tableHTML += `<p class="mt-2 text-sm text-gray-500">Showing 50 of ${data.length} rows</p>`;
            }
            
            return tableHTML;
        }

        function displayError(error) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `
                <div class="bg-red-50 border border-red-200 rounded-2xl p-6">
                    <div class="flex items-center text-red-600 mb-3">
                        <i class="fas fa-exclamation-triangle text-2xl mr-3"></i>
                        <h2 class="text-2xl font-semibold">Error</h2>
                    </div>
                    <p class="text-red-700">${error}</p>
                </div>
            `;
            resultsDiv.classList.remove('hidden');
            resultsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function addToHistory(query, data, database) {
            const historySection = document.getElementById('historySection');
            const historyList = document.getElementById('historyList');
            
            historySection.classList.remove('hidden');
            
            const historyItem = document.createElement('div');
            historyItem.className = 'bg-gray-50 rounded-lg p-4 border border-gray-200';
            historyItem.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex-1">
                        <div class="flex items-center mb-1">
                            <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs mr-2">${database}</span>
                            <p class="font-medium text-gray-800">${query}</p>
                        </div>
                        <p class="text-sm text-gray-600">${data.execution_result.row_count} rows • ${data.execution_time_ms}ms</p>
                    </div>
                    <button onclick="this.closest('.bg-gray-50').remove()" class="text-gray-400 hover:text-gray-600 ml-2">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            historyList.appendChild(historyItem);
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                const button = event.target;
                const originalHTML = button.innerHTML;
                button.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
                button.className = 'px-3 py-1 bg-green-200 text-green-800 rounded-lg text-sm';
                
                setTimeout(() => {
                    button.innerHTML = originalHTML;
                    button.className = 'px-3 py-1 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300';
                }, 2000);
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkSystemStatus();
        });
    </script>
</body>
</html>
'''
